(function(e){if('serviceWorker'in navigator&&window.location.protocol=='https:'){window.addEventListener('load',function(){navigator.serviceWorker.register('./sw.js')})};function t(t){for(var n,i,c=t[0],o=t[1],u=t[2],d=0,h=[];d<c.length;d++)i=c[d],Object.prototype.hasOwnProperty.call(a,i)&&a[i]&&h.push(a[i][0]),a[i]=0;for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n]);l&&l(t);while(h.length)h.shift()();return s.push.apply(s,u||[]),r()}function r(){for(var e,t=0;t<s.length;t++){for(var r=s[t],n=!0,c=1;c<r.length;c++){var o=r[c];0!==a[o]&&(n=!1)}n&&(s.splice(t--,1),e=i(i.s=r[0]))}return e}var n={},a={app:0},s=[];function i(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],o=c.push.bind(c);c.push=t,c=c.slice();for(var u=0;u<c.length;u++)t(c[u]);var l=o;s.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("56d7")},"034f":function(e,t,r){"use strict";r("85ec")},"05b2":function(e,t,r){},"0661":function(e,t,r){"use strict";r("9559")},1:function(e,t){},"1c76":function(e,t,r){"use strict";r("f535")},2:function(e,t){},3:function(e,t){},"3f2d":function(e,t,r){"use strict";r("ef9e")},4:function(e,t){},5:function(e,t){},"56d7":function(e,t,r){"use strict";r.r(t);var n=r("5530"),a=(r("e260"),r("e6cf"),r("cca6"),r("a79d"),r("2b0e")),s=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"app"}},[0==e.viewSelected?r("VKView",{attrs:{activePanel:"menu"}},[r("Panel",{attrs:{id:"menu"}},[r("PanelHeader",[e._v("Добро пожаловать")]),r("br"),r("Group",{attrs:{id:"homescreen-block"}},[r("Div",[e._v(" Это приложение позволяет осуществлять быстрый поиск по сообщеням, выгруженным с помощью экспорта данных из ВКонтакте. При первом запуске необходимо выбрать папку с сообщениями, импортировать и проиндексировать их. Все данные будут храниться локально. Отключите интернет на устройстве, чтобы в этом убедиться. Исходный код данного проекта открыт и доступен "),r("a",{attrs:{href:"https://github.com/remixer-dec/vk-export-msg-searcher",target:"_blank"}},[e._v("тут")]),e._v(". ")]),r("Div",[r("Button",{on:{click:function(t){return e.selectView(1)}}},[e._v("Импортировать сообщения")])],1),r("Div",[r("Button",{on:{click:function(t){return e.selectView(2)}}},[e._v("Перейти к просмотру")])],1)],1)],1)],1):e._e(),1==e.viewSelected?r("App",{on:{gohome:function(t){e.viewSelected=0}}}):e._e(),2==e.viewSelected?r("ViewerApp",{on:{gohome:function(t){e.viewSelected=0}}}):e._e()],1)},i=[],c=(r("ac1f"),r("5319"),function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"app"}},[r("VKView",{attrs:{activePanel:e.activePanel}},[r("Panel",{attrs:{id:"storageSourceSelector"}},[r("PanelHeader",[e._v("Импортировать сообщения в")]),r("Group",{attrs:{title:"Выберете, куда будут сохранены сообщения"}},[r("FormLayout",{staticClass:"leftform"},[r("Div",[r("Radio",{attrs:{name:"radio",value:"idb"}},[e._v("IndexedDB (этот браузер) (очень медленно)")]),r("Radio",{attrs:{default:"",modelValue:"wql",name:"radio",value:"wql"}},[e._v("WebSQL (этот браузер) (только для браузеров на основе Chromium)")]),r("Radio",{attrs:{name:"radio",value:"sql"}},[e._v("SQLite (файл)")])],1),r("Div",[r("Button",{attrs:{level:"outline"},on:{click:e.dbSelected}},[e._v("Далее")])],1)],1)],1)],1),r("Panel",{attrs:{id:"importSourceSelector"}},[r("PanelHeader",[e._v("Импорт сообщений из архива ВК")]),r("br"),r("Group",[r("Div",[r("label",{attrs:{for:"zipselect"}},[r("Button",[e._v("Импортировать из zip-папки с директорией messages")])],1)]),r("Div",[r("label",{attrs:{for:"dirselect"}},[r("Button",[e._v("Импортировать директорию messages")])],1)]),e.errorMsg?r("CellButton",{attrs:{level:"danger"}},[e._v(e._s(e.errorMsg))]):e._e()],1),e.storageQuotaSupported&&e.storage.quota<4e8&&!e.persisted&&"sql"!=e.radioValue?r("Div",[e._v(" Доступного места в хранилище браузера может не хватить для крупного архива сообщений. Сейчас сайту доступно "+e._s(~~(e.storage.quota/1e6))+" МБ. Освободите память, или дайте сайту разрешение на постоянное хранилище. В браузерах на основе Chromium для этого необходимо поднять приоритет сайта, для этого например можно включить у него уведомления. После чего необходимо обновить страницу и это сообщение исчезнет. ")]):e._e()],1),r("Panel",{attrs:{id:"loading"}},[r("PanelHeader",[e._v("Загрузка")]),r("Div",[r("Spinner")],1),r("Group",[r("Div",[r("Group",{attrs:{title:"Импорт всех диалогов"}},[r("InfoRow",{attrs:{title:e.progress+"%"}},[r("Progress",{attrs:{value:e.progress}})],1)],1),r("br"),r("Group",{attrs:{title:"Импорт всех файлов"}},[r("InfoRow",{attrs:{title:e.progress1+"%"}},[r("Progress",{attrs:{value:e.progress1}})],1)],1),r("br"),r("Group",{attrs:{title:e.progress2text}},[r("InfoRow",{attrs:{title:e.progress2+"%"}},[r("Progress",{attrs:{value:e.progress2}})],1)],1),r("br"),e.memoryUseSupported?r("Group",{attrs:{title:"Использование оперативной памяти"}},[r("InfoRow",{attrs:{title:e.memory+"%"}},[r("Progress",{attrs:{value:e.memory}})],1)],1):e._e(),e.storageQuotaSupported&&"sql"!=e.radioValue?r("Group",{attrs:{title:"Использование постоянной памяти"}},[r("InfoRow",{attrs:{title:e.storage.percent+"%"}},[r("Progress",{attrs:{value:e.storage.percent}})],1)],1):e._e()],1)],1)],1),r("Panel",{attrs:{id:"finalstep"}},[r("PanelHeader",[e._v("БД импортирована")]),r("br"),r("br"),r("br"),r("Div",["sql"==e.radioValue?r("Button",{on:{click:e.downloadDB}},[e._v("Скачать файл ещё раз")]):e._e()],1),r("Div",[r("Button",{on:{click:e.mainPage}},[e._v("На главную")])],1)],1)],1),r("input",{attrs:{type:"file",id:"dirselect",webkitdirectory:"",directory:""},on:{change:e.dirSelected}}),r("input",{attrs:{type:"file",id:"zipselect",accept:".zip"},on:{change:e.zipSelected}})],1)}),o=[],u=(r("99af"),r("13d5"),r("4ec9"),r("b64b"),r("d3b7"),r("07ac"),r("3ca3"),r("ddb0"),r("2909")),l=r("b85c"),d=(r("96cf"),r("1da1")),h=(r("7db0"),r("8a79"),r("466d"),r("2ca0"),r("c4e3")),f=r.n(h),p=r("d4ec"),m=r("bee2"),v=function(){function e(t){Object(p["a"])(this,e),this.src=t,this.filenames=Object.keys(this.src.files)}return Object(m["a"])(e,[{key:"getFileNames",value:function(){return this.filenames}},{key:"getFileContent",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new TextDecoder("windows-1251"),e.t0=r,e.next=4,this.src.file(t).async("uint8array");case 4:return e.t1=e.sent,e.abrupt("return",e.t0.decode.call(e.t0,e.t1));case 6:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}(),g=(r("a630"),r("d81d"),r("5cc6"),r("9a8c"),r("a975"),r("735e"),r("c1ac"),r("d139"),r("3a7b"),r("d5d6"),r("82f8"),r("e91f"),r("60bd"),r("5f96"),r("3280"),r("3fcc"),r("ca91"),r("25a1"),r("cd26"),r("3c5d"),r("2954"),r("649e"),r("219c"),r("170b"),r("b39a"),r("72f7"),function(){function e(t){Object(p["a"])(this,e),this.src=t,this.filenames=Array.from(this.src.files).map((function(e){return e.webkitRelativePath}))}return Object(m["a"])(e,[{key:"getFileNames",value:function(){return this.filenames}},{key:"getFileContent",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){var n=new FileReader,a=Array.from(r.src.files).find((function(e){return e.webkitRelativePath==t}));n.onload=function(){var t=new Uint8Array(n.result),r=new TextDecoder("windows-1251");e(r.decode(t))},n.readAsArrayBuffer(a)})));case 1:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()}]),e}()),b=function(){function e(){Object(p["a"])(this,e)}return Object(m["a"])(e,[{key:"parse",value:function(e){var t,r=new DOMParser,n=r.parseFromString(e,"text/html"),a=n.getElementsByClassName("item"),s={},i=Object(l["a"])(a);try{for(i.s();!(t=i.n()).done;){var c=t.value,o=c.getElementsByTagName("a")[0];s[o.getAttribute("href").match(/([0-9-]+)+\//)[1]]=o.innerText}}catch(u){i.e(u)}finally{i.f()}return s}}]),e}(),w={loadZip:function(e){return Object(d["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,f.a.loadAsync(e);case 2:return r=t.sent,t.next=5,w.contentLoaded(new v(r));case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t)})))()},loadFolder:function(e){return Object(d["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,w.contentLoaded(new g(e));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))()},msgFileStructureFormer:function(e){var t=e.find((function(e){return e.endsWith("index-messages.html")}));if(!t)throw new EvalError("Index file not found");var r,n="index-messages.html"==t?"":t.match(/(.+)index-messages.html/)[1],a={},s=Object(l["a"])(e);try{for(s.s();!(r=s.n()).done;){var i=r.value;if(i.startsWith(n)){var c=i.match(/([0-9-]+)\/messages([0-9]+)/);c&&(a[c[1]]?a[c[1]].push(parseInt(c[2])):a[c[1]]=[parseInt(c[2])])}}}catch(o){s.e(o)}finally{s.f()}return{chatFiles:a,index:t,indexDir:n}},contentLoaded:function(e){return Object(d["a"])(regeneratorRuntime.mark((function t(){var r,n,a,s,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=w.msgFileStructureFormer(e.getFileNames()),n=r.chatFiles,a=r.index,s=r.indexDir,t.t0=new b,t.next=4,e.getFileContent(a);case 4:return t.t1=t.sent,i=t.t0.parse.call(t.t0,t.t1),t.abrupt("return",{chats:i,chatFiles:n,indexDir:s,contentAdapterInstance:e});case 7:case"end":return t.stop()}}),t)})))()}},S=w,y=(r("2b3d"),{downloadBlob:function(e,t,r){var n,a;n=new Blob([e],{type:r}),a=window.URL.createObjectURL(n),y.downloadURL(a,t),setTimeout((function(){return window.URL.revokeObjectURL(a)}),1e3)},downloadURL:function(e,t){var r=document.createElement("a");r.href=e,r.download=t,r.style="display: none",document.body.appendChild(r),r.click(),r.remove()}}),k=y,_=(r("c975"),r("1276"),"янв|фев|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек".split("|")),x=function(){function e(){Object(p["a"])(this,e)}return Object(m["a"])(e,[{key:"parse",value:function(e,t){var r,n=new DOMParser,a=n.parseFromString(e.replace(/<br>/g,"\n"),"text/html"),s=a.getElementsByClassName("message"),i=[],c=new Map,o=Object(l["a"])(s);try{for(o.s();!(r=o.n()).done;){var u=r.value,d=/(public|club|id)([0-9-]+)/,h=u.firstElementChild.getElementsByTagName("a").length>0?u.firstElementChild.getElementsByTagName("a")[0].getAttribute("href").match(d):0,f="Вы";h&&(h=(h[1].match(/public|club/)?-1:1)*parseInt(h[2]),f=u.firstElementChild.firstElementChild.innerText),c.set(h,f);var p={id:parseInt(u.getAttribute("data-id")),cid:parseInt(t),from:h,date:this.parseDate(u.firstElementChild.textContent),txt:u.children[1].firstChild.innerText?"":1,att:[]},m=u.getElementsByClassName("attachment");if(0==m.length&&""==p.txt)try{p.txt=u.getElementsByClassName("kludges")[0].innerText}catch(w){p.txt=""}var v,g=Object(l["a"])(m);try{for(g.s();!(v=g.n()).done;){var b=v.value;p.att.push(this.parseAttachment(b))}}catch(S){g.e(S)}finally{g.f()}1===p.txt&&(u.getElementsByClassName("kludges").length>0&&u.children[1].removeChild(u.children[1].lastChild),p.txt=u.children[1].innerText),i.push(p)}}catch(S){o.e(S)}finally{o.f()}return{messages:i,fromDB:c}}},{key:"parseDate",value:function(e){var t=e.match(/([0-9]{1,2}) (янв|фев|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек) ([0-9]{4}) в ([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})/),r=new Date;return r.setYear(t[3]),r.setMonth(_.indexOf(t[2])),r.setDate(t[1]),r.setHours(t[4],t[5],t[6]),~~(r.getTime()/1e3)}},{key:"parseAttachment",value:function(e){var t=e.getElementsByClassName("attachment__link");return{desc:e.getElementsByClassName("attachment__description")[0].innerText,link:t.length>0?t[0].getAttribute("href"):void 0}}}]),e}(),E=r("fdac4"),R=r.n(E),O={idFilter:{all:function(e){return e},users:function(e){return e.id>=0&&e.id<2e9},groups:function(e){return e.id<0&&e.id>-2e9},chats:function(e){return e.id>=2e9}},SQLFilterFormer:function(e){var t="",r=0;for(var n in e)if("_"!=n[0]){0!=r&&(t+=" AND "),t+=n,t+=" ";var a=0;for(var s in e[n])0!=a&&(t+=" AND "+n+" "),t+=s+" ",t+=e[n][s],a++;r++}return"_order"in e&&(t+=" ORDER BY "+e["_order"],"_order_type"in e&&(t+=" "+e["_order_type"])),"_limit"in e&&(t+=" LIMIT "+e["_limit"]),"_offset"in e&&(t+=" OFFSET "+e["_offset"]),t}},C=O,T=function(){function e(){var t=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(p["a"])(this,e),this.db=!1,this.dbReady=new Promise((function(e,a){R()({locateFile:function(e){return"/"+e}}).then((function(s){if(r){var i=new s.Database;t.db=i,i.run("CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)"),i.run("CREATE TABLE chats (id INTEGER PRIMARY KEY, name TEXT)"),i.run("CREATE TABLE messages (id INTEGER PRIMARY KEY, uid INTEGER, cid INTEGER, txt TEXT, att TEXT, date INTEGER, FOREIGN KEY (uid) REFERENCES users(id))")}else t.db=new s.Database(n);t.db?e():a(0)}))}))}return Object(m["a"])(e,[{key:"addUser",value:function(e){this.db.run("INSERT INTO users (id, name) VALUES (".concat(e[0],", '").concat(this.q(e[1]),"')"))}},{key:"addMessage",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:r="INSERT INTO messages (id, uid, cid, txt, att, date)\n        VALUES (".concat(t.id,", ").concat(t.from,", ").concat(t.cid,", '").concat(this.q(t.txt),"', '").concat(t.att.length>0?this.q(JSON.stringify(t.att)):"","', ").concat(t.date,")"),this.db.run(r);case 2:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"addChat",value:function(e,t){this.db.run("INSERT INTO chats (id, name) VALUES (".concat(e,", '").concat(this.q(t),"')"))}},{key:"normalize",value:function(e){var t,r=[],n=Object(l["a"])(e.values);try{for(n.s();!(t=n.n()).done;){var a=t.value,s={};for(var i in e.columns)s[e.columns[i]]=a[i];r.push(s)}}catch(c){n.e(c)}finally{n.f()}return r}},{key:"getChats",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=t.db.exec("SELECT * FROM chats")[0];n?e(t.normalize(n)):r(0)})));case 1:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getUsers",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=t.db.exec("SELECT * FROM users")[0];n?e(t.normalize(n)):r(0)})));case 1:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getMessages",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var a=C.SQLFilterFormer(t),s=r.db.exec("SELECT * FROM messages WHERE ".concat(a))[0];s?e(r.normalize(s).map((function(e){return e.att=e.att?JSON.parse(e.att):e.att,e}))):n(0)})));case 1:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"q",value:function(e){return e.replace(/'/g,'"')}}]),e}(),P=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Object(p["a"])(this,e);var r=openDatabase("vkdb","1.0","Database with messages exported from VK",2097152,(function(){}));t&&r.transaction((function(e){e.executeSql("DROP TABLE IF EXISTS users",[]),e.executeSql("DROP TABLE IF EXISTS messages",[]),e.executeSql("DROP TABLE IF EXISTS chats",[]),e.executeSql("CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)"),e.executeSql("CREATE TABLE chats (id INTEGER PRIMARY KEY, name TEXT)"),e.executeSql("CREATE TABLE messages (id INTEGER PRIMARY KEY, uid INTEGER, cid INTEGER, txt TEXT, att TEXT, date INTEGER, FOREIGN KEY (uid) REFERENCES users(id))")})),this.db=r}return Object(m["a"])(e,[{key:"addUser",value:function(e){var t=this;this.db.transaction((function(r){r.executeSql("INSERT INTO users (id, name) VALUES (".concat(e[0],", '").concat(t.q(e[1]),"')"))}))}},{key:"addMessage",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:this.db.transaction((function(e){var n="INSERT INTO messages (id, uid, cid, txt, att, date) VALUES (".concat(t.id,", ").concat(t.from,", ").concat(t.cid,", '").concat(r.q(t.txt),"', '").concat(t.att.length>0?r.q(JSON.stringify(t.att)):"","', ").concat(t.date,")");e.executeSql(n)}));case 1:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"addChat",value:function(e,t){var r=this;this.db.transaction((function(n){n.executeSql("INSERT INTO chats (id, name) VALUES (".concat(e,", '").concat(r.q(t),"')"))}))}},{key:"getChats",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.db.transaction((function(t){t.executeSql("SELECT * FROM chats",[],(function(t,n){return e(Array.from(n.rows),(function(){return r(0)}))}))}))})));case 1:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getUsers",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.db.transaction((function(t){t.executeSql("SELECT * FROM users",[],(function(t,n){return e(Array.from(n.rows),(function(){return r(0)}))}))}))})));case 1:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getMessages",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var a=C.SQLFilterFormer(t);r.db.transaction((function(t){t.executeSql("SELECT * FROM messages WHERE ".concat(a),[],(function(t,r){return e(Array.from(r.rows).map((function(e){return e.att=e.att?JSON.parse(e.att):e.att,e})),(function(){return n(0)}))}))}))})));case 1:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"q",value:function(e){return e.replace(/'/g,'"')}},{key:"check",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){var t=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.db.transaction((function(t){t.executeSql("SELECT * FROM users",[],(function(){return e(!0)}),(function(){return r(!1)}))}))})).catch((function(e){return e}))||!1);case 1:case"end":return e.stop()}}),e)})));function t(){return e.apply(this,arguments)}return t}()}]),e}(),D=(r("6062"),r("4dec"));function L(e){return Array.from(new Set(e.replace(/[,.!?:"'()\n\r]/g,"").toLowerCase().split(" ")))}var I=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Object(p["a"])(this,e),t?D["a"].delete("vkdb").then(this.init()):this.init()}return Object(m["a"])(e,[{key:"addUser",value:function(e){this.db.users.put({id:e[0],name:e[1]})}},{key:"addMessage",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.db.messages.put({id:t.id,uid:t.from,cid:t.cid,txt:t.txt,att:t.att,date:t.date});case 2:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"addChat",value:function(e,t){this.db.chats.put({id:e,name:t})}},{key:"getChats",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.db.chats.toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getUsers",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.db.chats.toArray();case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getMessages",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(t){var r,n,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r={"<":"bellow",">":"above","=":"equals",LIKE:"equals"},n=this.db.messages,!("cid"in t)||!("id"in t)){e.next=6;break}n=n.where("cid").equals(t.cid["="]).and((function(e){return"<"in t.id?e.id<t.id["<"]:e.id>t.id[">"]})),e.next=19;break;case 6:if(!("date"in t)){e.next=10;break}n=n.where("date").between(t.date[">"],t.date["<"]),e.next=19;break;case 10:e.t0=regeneratorRuntime.keys(t);case 11:if((e.t1=e.t0()).done){e.next=19;break}if(a=e.t1.value,"_"!=a[0]){e.next=15;break}return e.abrupt("continue",11);case 15:for(s in n="LIKE"in t[a]?n.where("words"):n.where(a),t[a])"LIKE"==s&&(t[a][s]=t[a][s].replace(/[%']/g,"")),n=n[r[s]](t[a][s]);e.next=11;break;case 19:if("_offset"in t&&(n=n.offset(t["_offset"])),"_limit"in t&&(n=n.limit(t["_limit"])),!("_order"in t)){e.next=27;break}if(!("_order_type"in t)){e.next=27;break}return"ASC"!=t["_order_type"]&&(n=n.reverse()),e.next=26,n.sortBy(t["_order"]);case 26:n=e.sent;case 27:return e.abrupt("return","toArray"in n?n.toArray():n);case 28:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"init",value:function(){this.db=new D["a"]("vkdb"),this.db.version(1).stores({users:"id, name",chats:"id, name",messages:"id, uid, cid, txt, att, date, *words"}),this.db.messages.hook("creating",(function(e,t){"string"==typeof t.txt&&(t.words=L(t.txt))}))}},{key:"check",value:function(){var e=Object(d["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.db.users.count();case 2:return e.t0=e.sent,e.abrupt("return",0!=e.t0);case 4:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()}]),e}(),j={name:"App",data:function(){return{activePanel:"storageSourceSelector",status:"загрузка метаданных",errorMsg:!1,progress:0,progress1:0,progress2:0,progress2text:"",memory:0,storage:{quota:1/0,usage:0,percent:0},storageQuotaSupported:navigator.storage&&navigator.storage.estimate,memoryUseSupported:window.performance&&window.performance.memory,dbAdapters:{idb:I,wql:P,sql:T},dbProvider:!1,persisted:!1,radioValue:"wql"}},components:{},mixins:{FileOperationMixin:S},methods:{getStorageData:function(){var e=this;return Object(d["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.storageQuotaSupported){t.next=5;break}return t.next=3,navigator.storage.estimate();case 3:e.storage=t.sent,e.storage.percent=~~(e.storage.usage/e.storage.quota*100);case 5:case"end":return t.stop()}}),t)})))()},dbSelected:function(){var e=this;this.radioValue=document.querySelector("input[type=radio]:checked").value,this.dbProvider=new this.dbAdapters[this.radioValue](!0),"sql"!=this.radioValue&&navigator.storage&&navigator.storage.persist&&navigator.storage.persist().then((function(t){e.persisted=t})),this.getStorageData(),console.log(this),this.activePanel="importSourceSelector"},metaLoadingSuccess:function(e){this.startParsingMessages(e)},metaLoadingError:function(e){this.activePanel="importSourceSelector",this.errorMsg="Что-то пошло не так. Не удалось найти необходимые файлы. ("+e+")"},zipSelected:function(){var e=this,t=document.getElementById("zipselect");S.loadZip(t.files[0]).then((function(t){return e.metaLoadingSuccess(t)})).catch((function(t){return e.metaLoadingError(t)})),this.activePanel="loading"},dirSelected:function(){var e=this,t=document.getElementById("dirselect");S.loadFolder(t).then((function(t){return e.metaLoadingSuccess(t)})).catch((function(t){return e.metaLoadingError(t)})),this.activePanel="loading"},downloadDB:function(){k.downloadBlob(this.dbProvider.db.export(),"vk-msg.sqlite","application/octet-stream")},mainPage:function(){this.$emit("gohome")},startParsingMessages:function(e){var t=this;return Object(d["a"])(regeneratorRuntime.mark((function r(){var n,a,s,i,c,o,d,h,f,p,m,v,g,b,w,S,y,k,_;return regeneratorRuntime.wrap((function(r){while(1)switch(r.prev=r.next){case 0:n=Object.keys(e.chats),a=new x,s=n.length,i=0,c=0,o=Object.values(e.chatFiles).reduce((function(e,t){return e+t.length}),0),d=new Map,h=0,f=n;case 8:if(!(h<f.length)){r.next=51;break}p=f[h],i++,t.progress=~~(i/s*100),m=e.chatFiles[p].length,r.t0=regeneratorRuntime.keys(e.chatFiles[p]);case 14:if((r.t1=r.t0()).done){r.next=47;break}return v=r.t1.value,c++,0==v&&(t.progress2text="Импорт сообщений из диалога "+e.chats[p],t.getStorageData(),t.memory=t.memoryUseSupported?~~(window.performance.memory.usedJSHeapSize/window.performance.memory.jsHeapSizeLimit*100):0),r.t2=a,r.next=21,e.contentAdapterInstance.getFileContent(e.indexDir+p+"/messages"+e.chatFiles[p][v]+".html");case 21:r.t3=r.sent,r.t4=p,g=r.t2.parse.call(r.t2,r.t3,r.t4),b=Object(l["a"])(g.messages),r.prev=25,b.s();case 27:if((w=b.n()).done){r.next=34;break}return S=w.value,r.next=31,t.dbProvider.addMessage(S);case 31:S=void 0;case 32:r.next=27;break;case 34:r.next=39;break;case 36:r.prev=36,r.t5=r["catch"](25),b.e(r.t5);case 39:return r.prev=39,b.f(),r.finish(39);case 42:d=new Map([].concat(Object(u["a"])(d),Object(u["a"])(g.fromDB))),t.progress1=~~(c/o*100),t.progress2=~~(v/m*100),r.next=14;break;case 47:t.dbProvider.addChat(parseInt(p),e.chats[p]);case 48:h++,r.next=8;break;case 51:y=Object(l["a"])(d.entries());try{for(y.s();!(k=y.n()).done;)_=k.value,t.dbProvider.addUser(_)}catch(E){y.e(E)}finally{y.f()}d=void 0,t.activePanel="finalstep",localStorage["vkmsg-db-sel"]=t.radioValue,"sql"==t.radioValue&&t.downloadDB();case 57:case"end":return r.stop()}}),r,null,[[25,36,39,42]])})))()}}},A=j,B=(r("034f"),r("2877")),F=Object(B["a"])(A,c,o,!1,null,null,null),q=F.exports,M=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("VKView",{attrs:{activePanel:e.panel}},[r("Panel",{attrs:{id:"dialoglist"}},[r("PanelHeader",{scopedSlots:e._u([{key:"left",fn:function(){return[r("HeaderButton",{on:{click:e.mainPage}},[r("vkui-icon",{attrs:{name:"home"}})],1),r("HeaderButton",{on:{click:function(t){e.dbSelectorOpened=!e.dbSelectorOpened}}},[r("vkui-icon",{attrs:{name:"upload"}})],1)]},proxy:!0},{key:"right",fn:function(){return[e.searchOpened?r("HeaderButton",{on:{click:function(t){e.showDatePicker=!e.showDatePicker}}},[r("date-picker",{attrs:{type:"date",open:e.showDatePicker},on:{input:e.dateSelected}}),r("vkui-icon",{attrs:{name:"newsfeed"}})],1):e._e(),r("HeaderButton",{on:{click:function(t){e.filterOpened=!e.filterOpened}}},[r("vkui-icon",{attrs:{name:"filter"}})],1),r("HeaderButton",{on:{click:function(t){e.searchOpened=!e.searchOpened}}},[r("vkui-icon",{attrs:{name:"search"}})],1)]},proxy:!0}])},[e._v(" Диалоги ")]),r("HeaderContext",{attrs:{opened:e.dbSelectorOpened,onClose:e.closeDBSelector}},[r("List",[r("Cell",{on:{click:function(t){return e.selectDataSource("idb")}}},[e._v("Использовать IndexedDB")]),r("Cell",{on:{click:function(t){return e.selectDataSource("wql")}}},[e._v("Использовать WebSQL")]),r("label",{attrs:{for:"sqlDBselector"}},[r("Cell",[e._v("Загрузить из файла SQLite")])],1),e.dbError?r("CellButton",{attrs:{level:"danger",id:"dbError"}},[e._v(e._s(e.dbError))]):e._e(),r("input",{attrs:{type:"file",id:"sqlDBselector"},on:{change:e.fileSelected}})],1)],1),r("HeaderContext",{attrs:{opened:e.filterOpened,onClose:e.closeFilterSelector}},[r("Tabs",[r("TabsItem",{attrs:{selected:"all"==e.idFilter},on:{click:function(t){e.idFilter="all"}}},[e._v("Все")]),r("TabsItem",{attrs:{selected:"users"==e.idFilter},on:{click:function(t){e.idFilter="users"}}},[e._v("Люди")]),r("TabsItem",{attrs:{selected:"groups"==e.idFilter},on:{click:function(t){e.idFilter="groups"}}},[e._v("Группы")]),r("TabsItem",{attrs:{selected:"chats"==e.idFilter},on:{click:function(t){e.idFilter="chats"}}},[e._v("Беседы")])],1),r("BetterSearch",{attrs:{placeholder:"Поиск диалогов",cache:"dialogSearch"},on:{input:e.applyNameFilter}})],1),r("HeaderContext",{attrs:{opened:e.searchOpened,onClose:e.closeSearchBox}},[r("BetterSearch",{attrs:{placeholder:"Поиск сообщений",cache:"messageSearch"},on:{input:e.findMessages}})],1),e.filteredChats.length>0?r("Group",[r("List",e._l(e.filteredChats,(function(t,n){return r("Cell",{key:n,attrs:{cid:t.id},on:{click:function(r){return e.openDialog(t.id,t.name)}}},[e._v(" "+e._s(t.name)+" ")])})),1)],1):r("div",[e.chats.length>0?r("Div",[e._v("Нет результатов")]):r("div",[e.dbProvider?r("Div",[r("ScreenSpinner")],1):r("Div",[e._v("Выберете источник данных")])],1)],1)],1),r("Panel",{attrs:{id:"searchresults"}},[r("PanelHeader",{scopedSlots:e._u([{key:"left",fn:function(){return[r("HeaderButton",{on:{click:function(t){return e.goBack()}}},[r("vkui-icon",{attrs:{name:"back"}})],1)]},proxy:!0}])},[e._v(" Результаты поиска ")]),0==e.search.results.length?r("Div",[e._v("Нет результатов")]):r("SearchResults",{attrs:{data:e.search},on:{more:e.loadMoreSearchResults,chat:e.openDialogFromSearch}})],1),r("Panel",{attrs:{id:"dialogview"}},[r("PanelHeader",{scopedSlots:e._u([{key:"left",fn:function(){return[r("HeaderButton",{on:{click:function(t){return e.goBack()}}},[r("vkui-icon",{attrs:{name:"back"}})],1)]},proxy:!0}])},[e._v(" "+e._s(e.selectedChat.name)+" ")]),r("MessageList",{ref:"msglist",attrs:{messages:e.msgsInSelectedChat,chatid:e.selectedChat.id},on:{prevmsg:e.loadMoreMessages}})],1)],1)},N=[],H=(r("4de4"),r("b0c0"),r("4d63"),r("25f0"),r("841c"),function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{class:e.classNames},[r("div",{staticClass:"Search__in"},[r("div",{staticClass:"Search__width"}),r("div",{staticClass:"Search__control"},[r("input",e._b({directives:[{name:"model",rawName:"v-model",value:e.textvalue,expression:"textvalue"}],ref:"input",staticClass:"Search__input",attrs:{id:"search-"+e.searchId,type:"text",autoComplete:e.autoComplete},domProps:{value:e.textvalue},on:{focus:e.focusHandler,blur:e.blurHandler,keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.enterClicked(t)},input:function(t){t.target.composing||(e.textvalue=t.target.value)}}},"input",e.$attrs,!1)),e.$slots.after?r("div",{staticClass:"Search__after-width"}):e._e(),r("label",{staticClass:"Search__placeholder",attrs:{for:"search-"+e.searchId}},[r("div",{staticClass:"Search__placeholder-in"},[r("vkui-icon",{attrs:{name:"search",size:"16"}}),r("div",{staticClass:"Search__placeholder-text",domProps:{innerHTML:e._s(e.computedPlaceholder)}})],1)])]),r("div",{staticClass:"Search__after",on:{click:e.enterClicked}},[r("div",{staticClass:"Search__after-in"},[e._v(" Поиск ")])])])])}),$=[],U=r("ade3"),V=r("9023"),G=r("da06"),z=Object(V["a"])("Search"),K=0,Y={},Q={data:function(e){return{showAfter:!1,focused:!1,placeholderOffset:null,afterWidth:null,textvalue:Y[e.$props.cache]||""}},inheritAttrs:!1,computed:{computedPlaceholder:function(){return this.textvalue.length>0?"":this.placeholder},searchId:function(){return K},classNames:function(){var e,t=(e={},Object(U["a"])(e,"Search--".concat(this.theme),!0),Object(U["a"])(e,"Search--focused",this.focused),Object(U["a"])(e,"Search--has-value",!!this.value),Object(U["a"])(e,"Search--has-after",!!this.$slots.after),e);return Object(G["a"])(z,t)}},props:{value:{type:String,dafault:""},placeholder:{type:String,default:"Поиск"},theme:{type:String,required:!1,default:"default",validator:function(e){return["header","default"].indexOf(e)>=0}},autoComplete:{type:String,default:"off"},cache:{type:String,default:"search"}},created:function(){K++},methods:{enterClicked:function(){Y[this.$props.cache]=this.$refs.input.value,this.$emit("input",this.$refs.input.value)},focusHandler:function(){this.focused=!0},blurHandler:function(e){this.focused=!1,this.$emit("blur",e)},cancelHandler:function(){this.$emit("input",""),this.focused=!1}}},X=Q,J=(r("1c76"),Object(B["a"])(X,H,$,!1,null,null,null)),W=J.exports,Z=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{ref:"wrapper",staticClass:"messagelist-wrapper"},[r("virtual-list",{directives:[{name:"show",rawName:"v-show",value:!!e.messages.length,expression:"!!messages.length"}],ref:"vsl",staticClass:"msg-stream scroll-touch",attrs:{"data-key":"id","data-sources":e.messages,"data-component":e.messageComponent,"estimate-size":58,"item-class":"stream-item",keeps:30},on:{totop:function(t){return e.loadMore(-1)},tobottom:function(t){return e.loadMore(1)}}})],1)},ee=[],te=(r("c740"),r("fb6a"),function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"message",class:{"message-right":0==e.source.uid,"message-plus-date":""!=e.date},attrs:{set:e.date=e.getDate(e.source.date)}},[e.date?r("div",{staticClass:"date"},[e._v(e._s(e.date))]):e._e(),r("span",{domProps:{innerHTML:e._s(e.activateLinks(e.source.txt))}}),r("div",{domProps:{innerHTML:e._s(e.getAttachmentsHTML(e.source))}}),r("div",{staticClass:"bottomtext"},[e.source.cid>=2e9?r("span",{staticClass:"msgauthor"},[e._v(e._s(e.source.uname)+" в ")]):e._e(),e._v(" "+e._s(e.getTime(e.source.date))+" ")])])}),re=[],ne=(r("9911"),0),ae={data:function(){return{date:""}},props:{source:{type:Object,default:function(){return{id:"",cid:0,uid:0,txt:0,date:0,att:[]}}}},methods:{activateLinks:function(e){var t=/((https?:\/\/|)[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*))/gim;return e=e.replace(t,'<a target="_blank" href="$1">$1</a>'),e},getTime:function(e){return new Date(1e3*e).toLocaleTimeString()},getDate:function(e){var t=new Date(1e3*e).toLocaleDateString();return ne==t?"":(ne=t,t)},getAttachmentsHTML:function(e){var t="";if(e.att){var r,n=Object(l["a"])(e.att);try{for(n.s();!(r=n.n()).done;){var a=r.value;switch(a.desc){case"Фотография":t+='<a href="'.concat(a.link,'" target="_blank"><img src="').concat(a.link,'" class="msg-img"></a>');break;default:a.desc.match("прикреп")?t+='<div class="attach forwarded">'.concat(a.desc,"</div>"):a.link?t+='<div><a href="'.concat(a.link,'" class="attach">').concat(a.desc,"</a></div>"):t+='<div class="attach">'.concat(a.desc,"</div>");break}}}catch(s){n.e(s)}finally{n.f()}}return t}}},se=ae,ie=Object(B["a"])(se,te,re,!1,null,"9fa9e192",null),ce=ie.exports,oe=r("89c1"),ue=r.n(oe),le={props:["messages","chatid"],mounted:function(){var e=this;this.$refs.vsl.scrollToBottom(),setTimeout((function(){e.$refs.vsl.scrollToBottom()}),100),setTimeout((function(){e.dataRequest=!1}),600)},beforeUpdate:function(){var e=this;this.dataRequest&&-1==this.msgLoadDir&&(this.sids=this.messages.slice(0,this.messages.findIndex((function(t){return t.id==e.firstMid}))).map((function(e){return e.id})),this.$nextTick(this.fixPosition))},updated:function(){this.msgLoadDir&&(this.dataRequest=!1)},components:{VirtualList:ue.a},methods:{loadMore:function(e){if(!this.dataRequest){this.dataRequest=!0,this.msgLoadDir=e,this.firstMid=this.messages[0].id;var t=this.messages[this.messages.length-1].id;this.$emit("prevmsg",{dir:e,mid:e<0?this.firstMid:t})}},fixPosition:function(){var e=this,t=this.sids;if(0!=t.length){var r=t.reduce((function(t,r){return t+e.$refs.vsl.getSize(r)}),0);this.$refs.vsl.scrollToOffset(r)}}},data:function(){return{dataRequest:!0,msgLoadDir:0,sids:[],firstMid:0,messageComponent:ce}}},de=le,he=(r("e3b5"),Object(B["a"])(de,Z,ee,!1,null,null,null)),fe=he.exports,pe=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{ref:"reswrapper",staticClass:"wrapper"},[r("Group",[r("List",e._l(e.data.results,(function(t,n){return r("Cell",{key:n,on:{click:function(r){return e.loadDialog(t.cid,t.id)}}},[e._v(" "+e._s(t.txt)+" "),r("div",{staticClass:"search-meta"},[e._v(e._s(t.uname)+" "),t.uid==t.cid?r("span",[e._v("в личном сообщении ")]):r("span",[e._v("в диалоге "+e._s(t.cname)+" ")]),e._v("в "+e._s(e.getDate(t.date)))])])})),1)],1)],1)},me=[],ve={mounted:function(){this.scrollTarget=this.$refs.reswrapper.parentElement.parentElement.parentElement,this.scrollTarget.addEventListener("scroll",this.scrollHandler)},unmounted:function(){this.scrollTarget.removeEventListener("scroll",this.scrollHandler)},beforeUpdate:function(){this.dataRequest=!1},data:function(){return{dataRequest:!1,scrollTarget:!1}},props:["data"],methods:{scrollHandler:function(){this.scrollTarget.scrollTop>this.scrollTarget.scrollHeight-document.body.offsetHeight-200&&!this.dataRequest&&(this.dataRequest=!0,this.$emit("more"))},getDate:function(e){return new Date(1e3*e).toLocaleDateString()},loadDialog:function(e,t){this.$emit("chat",{cid:e,mid:t})}}},ge=ve,be=(r("a65a"),Object(B["a"])(ge,pe,me,!1,null,"90f78620",null)),we=be.exports,Se=r("ec45"),ye=(r("411c"),{name:"ViewerApp",provide:{webviewType:"internal"},components:{BetterSearch:W,MessageList:fe,DatePicker:Se["a"],SearchResults:we},computed:{filteredChats:function(){var e=this,t=this.chats.filter((function(t){return C["idFilter"][e.idFilter](t)}));if(this.chatNameFilter){var r=new RegExp(this.chatNameFilter,"i");t=t.filter((function(e){return e.name.match(r)}))}return t}},methods:{fileSelected:function(){var e=this,t=window.sqlDBselector.files[0],r=new FileReader;this.dbError="Загрузка...",r.onload=function(){var t=new Uint8Array(r.result);e.dbProvider=new e.dbAdapters["sql"](!1,t),e.dbProvider.dbReady.then((function(){e.dbError=!1,e.loadChatList()})),e.closeDBSelector()},r.readAsArrayBuffer(t)},selectDataSource:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dbProvider=new this.dbAdapters[e](!1),this.dbProvider.check().then((function(e){t.dbError=!e&&"Не удалось найти данные в выбранной БД.",r&&!e&&(t.dbError="",t.dbSelectorOpened=!0),e&&(t.closeDBSelector(),t.loadChatList())}))},closeDBSelector:function(){this.dbSelectorOpened=!1},closeFilterSelector:function(){this.filterOpened=!1},closeSearchBox:function(){this.searchOpened=!1},goBack:function(){history.back()},mainPage:function(){this.$emit("gohome"),window.location.replace("#")},loadChatList:function(){var e=this;this.dbProvider.getChats().then((function(t){e.chats=t,e.chats.map((function(t){e.chatsById[t.id]=t.name})),e.loadUserList()}))},loadUserList:function(){var e=this;this.dbProvider.getUsers().then((function(t){t.map((function(t){e.usersById[t.id]=t.name}))}))},applyNameFilter:function(e){this.chatNameFilter=e,this.closeFilterSelector()},addUsername:function(e){for(var t=0,r=e.length;t<r;t++)e[t]["uname"]=this.usersById[e[t].uid]||"";return e},addChatname:function(e){for(var t=0,r=e.length;t<r;t++)e[t]["cname"]=this.chatsById[e[t].cid]||"";return e},openDialog:function(e,t){var r=this;this.resetSelectedChat(t,e),history.pushState({},"Просмотр сообщений","#viewer/messages"),this.selectedChat.bottomLimitReached=!0,this.dbProvider.getMessages({cid:{"=":e},_limit:30,_order:"id",_order_type:"DESC"}).then((function(e){r.addUsername(e),r.msgsInSelectedChat=e.reverse()}))},loadMoreMessages:function(e){var t=this,r=e.dir,n=e.mid,a=r>0?{">":n}:{"<":n};if(-1==r&&this.selectedChat.topLimitReached||1==r&&this.selectedChat.bottomLimitReached)this.$refs.msglist.dataRequest=!1;else{var s={cid:{"=":this.selectedChat.id},id:a,_limit:30,_order:"id",_order_type:-1==r?"DESC":"ASC"};this.dbProvider.getMessages(s).then((function(e){0==e.length&&(t.limitReached(r),t.$refs.msglist.dataRequest=!1),t.addUsername(e),t.msgsInSelectedChat=r<0?[].concat(Object(u["a"])(e.reverse()),Object(u["a"])(t.msgsInSelectedChat)):[].concat(Object(u["a"])(t.msgsInSelectedChat),Object(u["a"])(e))})).catch((function(){t.limitReached(r),t.$refs.msglist.dataRequest=!1}))}},limitReached:function(e){-1==e?this.selectedChat.topLimitReached=!0:this.selectedChat.bottomLimitReached=!0},openDialogFromSearch:function(e){var t=e.cid,r=e.mid;history.pushState({},"Просмотр сообщений","#viewer/messages"),this.resetSelectedChat(this.chats.find((function(e){return e.id==t})).name,t),this.loadMoreMessages({dir:-1,mid:r+5})},dateSelected:function(e){var t=new Date(e.setHours(0)),r=new Date(e.setDate(e.getDate()+1));this.showDatePicker=!1,this.dateSearch(~~(t.getTime()/1e3),~~(r.getTime()/1e3))},resetSelectedChat:function(e,t){this.selectedChat.name=e,this.selectedChat.id=t,this.panel="dialogview",this.selectedChat.topLimitReached=!1,this.selectedChat.bottomLimitReached=!1,this.msgsInSelectedChat=[]},dateSearch:function(e,t){var r=this;history.pushState({},"Поиск по дате","#viewer/searchbydate"),this.panel="searchresults",this.dbProvider.getMessages({date:{"<":t,">":e},_order:"id",_order_type:"DESC"}).then((function(e){r.search.results=e})).catch((function(){}))},runSearch:function(e,t){var r=this;this.dbProvider.getMessages({txt:{LIKE:"'%".concat(e.replace(/%|'/g,""),"%'")},_limit:30,_offset:t,_order:"id",_order_type:"DESC"}).then((function(e){r.search.results=[].concat(Object(u["a"])(r.search.results),Object(u["a"])(e)),r.search.offset+=30})).catch((function(){r.search.offset}))},findMessages:function(e){""!=e&&(history.pushState({},"Поиск сообщений","#viewer/search"),this.panel="searchresults",this.search.results=[],this.search.query=e,this.search.offset=0,this.runSearch(e,0))},loadMoreSearchResults:function(){this.runSearch(this.search.query,this.search.offset)}},watch:{"search.results":function(){this.addUsername(this.search.results),this.addChatname(this.search.results)}},created:function(){var e=this;this.$root.$off("back"),this.$root.$on("back",(function(){switch(e.panel){case"dialoglist":e.filterOpened||e.searchOpened||e.dbSelectorOpened?(e.filterOpened=!1,e.searchOpened=!1,e.dbSelectorOpened=!1):e.mainPage();break;case"searchresults":e.panel="dialoglist";break;case"dialogview":e.panel=e.searchOpened?"searchresults":"dialoglist";break}}))},mounted:function(){this.dbChoice&&"sql"!=this.dbChoice?this.selectDataSource(this.dbChoice,!0):this.dbSelectorOpened=!0},data:function(){return{chats:[],chatsById:{},usersById:{},selectedChat:{id:0,name:"",topLimitReached:!1,bottomLimitReached:!1},search:{query:"",offset:0,results:[]},msgsInSelectedChat:[],showDatePicker:!1,dbChoice:localStorage["vkmsg-db-sel"],dbAdapters:{idb:I,wql:P,sql:T},dbSelectorOpened:!1,filterOpened:!1,searchOpened:!1,dbError:!1,dbProvider:!1,idFilter:"all",chatNameFilter:"",panel:"dialoglist"}}}),ke=ye,_e=(r("0661"),Object(B["a"])(ke,M,N,!1,null,null,null)),xe=_e.exports,Ee={data:function(){return{viewSelected:0}},components:{App:q,ViewerApp:xe},mounted:function(){window.location.hash.length>1&&window.location.replace("#")},methods:{selectView:function(e){1==e?history.pushState({},"Импорт сообщений","#import"):history.pushState({},"Просмотрщик сообщений","#viewer"),this.viewSelected=e}}},Re=Ee,Oe=(r("fde4"),r("3f2d"),Object(B["a"])(Re,s,i,!1,null,"88b87e0c",null)),Ce=Oe.exports,Te=r("e9dc"),Pe=r("4947"),De=(r("1bc1"),r("5cd9")),Le=r.n(De);a["default"].config.productionTip=!1,a["default"].use(Le.a);var Ie=new a["default"]({components:Object(n["a"])(Object(n["a"])({},Te["a"]),Pe["a"]),render:function(e){return e(Ce)}}).$mount("#app");window.onhashchange=function(){Ie.$emit("back")}},"59fc":function(e,t,r){},6:function(e,t){},7:function(e,t){},"85ec":function(e,t,r){},9559:function(e,t,r){},a65a:function(e,t,r){"use strict";r("05b2")},b218:function(e,t,r){},e3b5:function(e,t,r){"use strict";r("59fc")},ef9e:function(e,t,r){},f535:function(e,t,r){},fde4:function(e,t,r){"use strict";r("b218")}});
//# sourceMappingURL=app.9bc3a88e.js.map